@model IndexNoteDto

@{
	ViewData["Title"] = "Notes";
}

<h1>Notes</h1>

<h5>All your notes, here.</h5>

<a asp-action="Create" class="btn btn-primary mb-3">Add new</a>

<table class="table">
	<thead>
	<th>User</th>
	<th>Note</th>
	<th>Importance</th>
	<th>Creation Date</th>
	<th>Likes</th>
	<th>Actions</th>
	</thead>

	<tbody>
		@foreach (Note n in Model.Notes)
		{
			<tr id="@n.Id">
				<td id="userName-@n.Id"> @n.User.UserName</td>
				<td id="text-@n.Id"> @n.Text</td>
				<td id="-@n.Id"> @n.NoteImportance.Importance</td>
				<td id="-@n.Id"> @n.CreationDate</td>
				<td id="noteLikes-@n.Id"> @n.Likes.Count</td>
				<td>
					@if (n.UserId == Model.UserId)
					{
						<a id="editBtn-@n.Id" class="btn btn-primary" asp-action="Edit" asp-route-id="@n.Id"><i class="bi-pencil-fill"></i></a>
						<a id="deleteBtn-@n.Id" class="btn btn-danger" asp-action="Delete" asp-route-id="@n.Id"><i class="bi-trash-fill"></i></a>
					}
					else
					{
						<a id="likeBtn-@n.Id" class="btn btn-success likeButton" @*asp-action="Like" asp-route-id="@n.Id"*@><i class="bi-hand-thumbs-up-fill"></i></a>
					}

					<input type="hidden" value="@n.Id" class="id" />
				</td>
			</tr>
		}
	</tbody>

</table>

@section Scripts {
	<script>

		function getNoteId(button) {
			return button.attr("id").split('-')[1];
			//previous implementation
			//return button.closest('tr').find('.id').val(); // Retrieve the note ID from the closest row to the button
		}

		const urlSetLike = '@Url.Action("SetLike", "NoteLike")';

		$(function () {
			$(".likeButton").on('click', function (e) {
				e.preventDefault();

				const noteId = getNoteId($(this));

				const dataToSend = {
					noteId: noteId,
					userId: @Model.UserId, // Include the user ID directly from the model
				};

				console.log(JSON.stringify(dataToSend))

				$.ajax({
					url: urlSetLike,
					type: 'POST',
					contentType: 'application/json', // Set the content type to JSON
					data: JSON.stringify(dataToSend),
					success: function (response, status, jqxhr) {
						console.log("done!!: ", response)
						const id = "#noteLikes-" + noteId;
						//$(id).text(response.length);
						$(id).html(response.length);
					},
					error: function (jqxhr, status, error) {
						console.log("fail :(");
					}
				});
			});
		});

		//NOT WORKING
		/*
		$(function () {

			$(".likeButton").on('click', function (e) {
				e.preventDefault();

				const noteId = getNoteId($(this));

				console.log("getNoteID: ", noteId);
				console.log("json ->", JSON.stringify(noteId))
				console.log("json2 ->", { noteId: noteId })
				$.post(urlSetLike, { noteId: noteId })
					.done(function (response, status, jqxhr) {
						console.log("done!!")
						// this is the "success" callback
					})
					.fail(function (jqxhr, status, error) {
						console.log("fail :(")
						// this is the ""error"" callback
					})
			})
		})
		*/

	</script>
}